import{parseSetCookie as te}from"cookie-es";import{fromJSON as I,crossSerializeStream as se,getCrossReferenceHeader as re}from"seroval";import{CustomEventPlugin as $,DOMExceptionPlugin as v,EventPlugin as k,FormDataPlugin as q,HeadersPlugin as H,ReadableStreamPlugin as T,RequestPlugin as E,ResponsePlugin as C,URLSearchParamsPlugin as P,URLPlugin as A}from"seroval-plugins/web";import{lazy as ne,createComponent as oe,sharedConfig as X}from"solid-js";import{ssrElement as m,escape as ae,mergeProps as ie,ssr as ce,getRequestEvent as ue,isServer as le,renderToString as pe}from"solid-js/web";import{provideRequestEvent as z}from"solid-js/web/storage";import{H3Event as F,setHeader as de,appendResponseHeader as fe,getRequestIP as he,parseCookies as ge,getResponseStatus as me,getResponseStatusText as ye,getCookie as Re,setCookie as we,getResponseHeader as Se,setResponseHeader as be,removeResponseHeader as xe,getResponseHeaders as $e,getRequestURL as ve,getRequestWebStream as ke,setResponseStatus as qe,eventHandler as He}from"h3";import{getContext as Te}from"unctx";import{AsyncLocalStorage as Ee}from"node:async_hooks";import{createRouter as Ce}from"radix3";function Pe(e){let s;const t=G(e),n={duplex:"half",method:e.method,headers:e.headers};return e.node.req.body instanceof ArrayBuffer?new Request(t,{...n,body:e.node.req.body}):new Request(t,{...n,get body(){return s||(s=We(e),s)}})}function Ae(e){return e.web??={request:Pe(e),url:G(e)},e.web.request}function Fe(){return Xe()}const J=Symbol("$HTTPEvent");function Le(e){return typeof e=="object"&&(e instanceof F||e?.[J]instanceof F||e?.__is_event__===!0)}function u(e){return function(...s){let t=s[0];if(Le(t))s[0]=t instanceof F||t.__is_event__?t:t[J];else{if(!globalThis.app.config.server.experimental?.asyncContext)throw new Error("AsyncLocalStorage was not enabled. Use the `server.experimental.asyncContext: true` option in your app configuration to enable it. Or, pass the instance of HTTPEvent that you have as the first argument to the function.");if(t=Fe(),!t)throw new Error("No HTTPEvent found in AsyncLocalStorage. Make sure you are using the function within the server runtime.");s.unshift(t)}return e(...s)}}const G=u(ve),Ue=u(he),w=u(qe),_=u(me),Oe=u(ye),y=u($e),j=u(Se),Ie=u(be),K=u(fe),_e=u(ge),je=u(Re),Me=u(we),R=u(de),We=u(ke),Ne=u(xe),Be=u(Ae);function De(){return Te("nitro-app",{asyncContext:!!globalThis.app.config.server.experimental?.asyncContext,AsyncLocalStorage:Ee})}function Xe(){return De().use().event}const S="Invariant Violation",{setPrototypeOf:ze=function(e,s){return e.__proto__=s,e}}=Object;class L extends Error{framesToPop=1;name=S;constructor(s=S){super(typeof s=="number"?`${S}: ${s} (see https://github.com/apollographql/invariant-packages)`:s),ze(this,L.prototype)}}function Je(e,s){if(!e)throw new L(s)}const b="solidFetchEvent";function Ge(e){return{request:Be(e),response:Ye(e),clientAddress:Ue(e),locals:{},nativeEvent:e}}function Ke(e){return{...e}}function Ve(e){if(!e.context[b]){const s=Ge(e);e.context[b]=s}return e.context[b]}function M(e,s){for(const[t,n]of s.entries())K(e,t,n)}class Qe{event;constructor(s){this.event=s}get(s){const t=j(this.event,s);return Array.isArray(t)?t.join(", "):t||null}has(s){return this.get(s)!==null}set(s,t){return Ie(this.event,s,t)}delete(s){return Ne(this.event,s)}append(s,t){K(this.event,s,t)}getSetCookie(){const s=j(this.event,"Set-Cookie");return Array.isArray(s)?s:[s]}forEach(s){return Object.entries(y(this.event)).forEach(([t,n])=>s(Array.isArray(n)?n.join(", "):n,t,this))}entries(){return Object.entries(y(this.event)).map(([s,t])=>[s,Array.isArray(t)?t.join(", "):t])[Symbol.iterator]()}keys(){return Object.keys(y(this.event))[Symbol.iterator]()}values(){return Object.values(y(this.event)).map(s=>Array.isArray(s)?s.join(", "):s)[Symbol.iterator]()}[Symbol.iterator](){return this.entries()[Symbol.iterator]()}}function Ye(e){return{get status(){return _(e)},set status(s){w(e,s)},get statusText(){return Oe(e)},set statusText(s){w(e,_(e),s)},headers:new Qe(e)}}const V=[{page:!0,$component:{src:"src/routes/about.tsx?pick=default&pick=$css",build:()=>import("../about.js"),import:()=>import("../about.js")},path:"/about",filePath:"/Users/wadakatu/www/experiments/screenbook/examples/solidstart/src/routes/about.tsx"},{page:!0,$component:{src:"src/routes/index.tsx?pick=default&pick=$css",build:()=>import("../index.js"),import:()=>import("../index.js")},path:"/",filePath:"/Users/wadakatu/www/experiments/screenbook/examples/solidstart/src/routes/index.tsx"},{page:!0,$component:{src:"src/routes/users/[id]/index.tsx?pick=default&pick=$css",build:()=>import("../index2.js"),import:()=>import("../index2.js")},path:"/users/:id/",filePath:"/Users/wadakatu/www/experiments/screenbook/examples/solidstart/src/routes/users/[id]/index.tsx"},{page:!0,$component:{src:"src/routes/users/index.tsx?pick=default&pick=$css",build:()=>import("../index3.js"),import:()=>import("../index3.js")},path:"/users/",filePath:"/Users/wadakatu/www/experiments/screenbook/examples/solidstart/src/routes/users/index.tsx"}],Ze=et(V.filter(e=>e.page));function et(e){function s(t,n,o,a){const i=Object.values(t).find(c=>o.startsWith(c.id+"/"));return i?(s(i.children||(i.children=[]),n,o.slice(i.id.length)),t):(t.push({...n,id:o,path:o.replace(/\([^)/]+\)/g,"").replace(/\/+/g,"/")}),t)}return e.sort((t,n)=>t.path.length-n.path.length).reduce((t,n)=>s(t,n,n.path,n.path),[])}function tt(e){return e.$HEAD||e.$GET||e.$POST||e.$PUT||e.$PATCH||e.$DELETE}Ce({routes:V.reduce((e,s)=>{if(!tt(s))return e;let t=s.path.replace(/\([^)/]+\)/g,"").replace(/\/+/g,"/").replace(/\*([^/]*)/g,(n,o)=>`**:${o}`).split("/").map(n=>n.startsWith(":")||n.startsWith("*")?n:encodeURIComponent(n)).join("/");if(/:[^/]*\?/g.test(t))throw new Error(`Optional parameters are not supported in API routes: ${t}`);if(e[t])throw new Error(`Duplicate API routes for "${t}" found at "${e[t].route.path}" and "${s.path}"`);return e[t]={route:s},e},{})});function st(e){e.forEach(s=>{if(!s.attrs.href)return;let t=document.head.querySelector(`link[href="${s.attrs.href}"]`);t||(t=document.createElement("link"),t.setAttribute("rel","preload"),t.setAttribute("as","style"),t.setAttribute("href",s.attrs.href),document.head.appendChild(t))})}var rt=" ";const nt={style:e=>m("style",e.attrs,()=>e.children,!0),link:e=>m("link",e.attrs,void 0,!0),script:e=>e.attrs.src?m("script",ie(()=>e.attrs,{get id(){return e.key}}),()=>ce(rt),!0):null,noscript:e=>m("noscript",e.attrs,()=>ae(e.children),!0)};function ot(e,s){let{tag:t,attrs:{key:n,...o}={key:void 0},children:a}=e;return nt[t]({attrs:{...o,nonce:s},key:n,children:a})}function at(e,s,t,n="default"){return ne(async()=>{{const a=(await e.import())[n],c=(await s.inputs?.[e.src].assets()).filter(p=>p.tag==="style"||p.attrs.rel==="stylesheet");return typeof window<"u"&&st(c),{default:p=>[...c.map(h=>ot(h)),oe(a,p)]}}})}function Q(){function e(t){return{...t,...t.$$route?t.$$route.require().route:void 0,info:{...t.$$route?t.$$route.require().route.info:{},filesystem:!0},component:t.$component&&at(t.$component,globalThis.MANIFEST.client,globalThis.MANIFEST.ssr),children:t.children?t.children.map(e):void 0}}return Ze.map(e)}let W;const kt=le?()=>ue().routes:()=>W||(W=Q());function it(e){const s=je(e.nativeEvent,"flash");if(s)try{let t=JSON.parse(s);if(!t||!t.result)return;const n=[...t.input.slice(0,-1),new Map(t.input[t.input.length-1])],o=t.error?new Error(t.result):t.result;return{input:n,url:t.url,pending:!1,result:t.thrown?void 0:o,error:t.thrown?o:void 0}}catch(t){console.error(t)}finally{Me(e.nativeEvent,"flash","",{maxAge:0})}}async function ct(e){const s=globalThis.MANIFEST.client;return globalThis.MANIFEST.ssr,e.response.headers.set("Content-Type","text/html"),Object.assign(e,{manifest:await s.json(),assets:[...await s.inputs[s.handler].assets()],router:{submission:it(e)},routes:Q(),complete:!1,$islands:new Set})}const ut=new Set([301,302,303,307,308]);function lt(e){return e.status&&ut.has(e.status)?e.status:302}const pt={};function dt(e){const s=new TextEncoder().encode(e),t=s.length,n=t.toString(16),o="00000000".substring(0,8-n.length)+n,a=new TextEncoder().encode(`;0x${o};`),i=new Uint8Array(12+t);return i.set(a),i.set(s,12),i}function N(e,s){return new ReadableStream({start(t){se(s,{scopeId:e,plugins:[$,v,k,q,H,T,E,C,P,A],onSerialize(n,o){t.enqueue(dt(o?`(${re(e)},${n})`:n))},onDone(){t.close()},onError(n){t.error(n)}})}})}async function ft(e){const s=Ve(e),t=s.request,n=t.headers.get("X-Server-Id"),o=t.headers.get("X-Server-Instance"),a=t.headers.has("X-Single-Flight"),i=new URL(t.url);let c,d;if(n)Je(typeof n=="string","Invalid server function"),[c,d]=n.split("#");else if(c=i.searchParams.get("id"),d=i.searchParams.get("name"),!c||!d)return new Response(null,{status:404});const p=pt[c];let h;if(!p)return new Response(null,{status:404});h=await p.importer();const Y=h[p.functionName];let f=[];if(!o||e.method==="GET"){const r=i.searchParams.get("args");if(r){const l=JSON.parse(r);(l.t?I(l,{plugins:[$,v,k,q,H,T,E,C,P,A]}):l).forEach(g=>f.push(g))}}if(e.method==="POST"){const r=t.headers.get("content-type"),l=e.node.req,g=l instanceof ReadableStream,Z=l.body instanceof ReadableStream,U=g&&l.locked||Z&&l.body.locked,O=g?l:l.body;if(r?.startsWith("multipart/form-data")||r?.startsWith("application/x-www-form-urlencoded"))f.push(await(U?t:new Request(t,{...t,body:O})).formData());else if(r?.startsWith("application/json")){const ee=U?t:new Request(t,{...t,body:O});f=I(await ee.json(),{plugins:[$,v,k,q,H,T,E,C,P,A]})}}try{let r=await z(s,async()=>(X.context={event:s},s.locals.serverFunctionMeta={id:c+"#"+d},Y(...f)));if(a&&o&&(r=await D(s,r)),r instanceof Response){if(r.headers&&r.headers.has("X-Content-Raw"))return r;o&&(r.headers&&M(e,r.headers),r.status&&(r.status<300||r.status>=400)&&w(e,r.status),r.customBody?r=await r.customBody():r.body==null&&(r=null))}return o?(R(e,"content-type","text/javascript"),N(o,r)):B(r,t,f)}catch(r){if(r instanceof Response)a&&o&&(r=await D(s,r)),r.headers&&M(e,r.headers),r.status&&(!o||r.status<300||r.status>=400)&&w(e,r.status),r.customBody?r=r.customBody():r.body==null&&(r=null),R(e,"X-Error","true");else if(o){const l=r instanceof Error?r.message:typeof r=="string"?r:"true";R(e,"X-Error",l.replace(/[\r\n]+/g,""))}else r=B(r,t,f,!0);return o?(R(e,"content-type","text/javascript"),N(o,r)):r}}function B(e,s,t,n){const o=new URL(s.url),a=e instanceof Error;let i=302,c;return e instanceof Response?(c=new Headers(e.headers),e.headers.has("Location")&&(c.set("Location",new URL(e.headers.get("Location"),o.origin+"").toString()),i=lt(e))):c=new Headers({Location:new URL(s.headers.get("referer")).toString()}),e&&c.append("Set-Cookie",`flash=${encodeURIComponent(JSON.stringify({url:o.pathname+o.search,result:a?e.message:e,thrown:n,error:a,input:[...t.slice(0,-1),[...t[t.length-1].entries()]]}))}; Secure; HttpOnly;`),new Response(null,{status:i,headers:c})}let x;function ht(e){const s=new Headers(e.request.headers),t=_e(e.nativeEvent),n=e.response.headers.getSetCookie();s.delete("cookie");let o=!1;return e.nativeEvent.node?.req&&(o=!0,e.nativeEvent.node.req.headers.cookie=""),n.forEach(a=>{if(!a)return;const{maxAge:i,expires:c,name:d,value:p}=te(a);if(i!=null&&i<=0){delete t[d];return}if(c!=null&&c.getTime()<=Date.now()){delete t[d];return}t[d]=p}),Object.entries(t).forEach(([a,i])=>{s.append("cookie",`${a}=${i}`),o&&(e.nativeEvent.node.req.headers.cookie+=`${a}=${i};`)}),s}async function D(e,s){let t,n=new URL(e.request.headers.get("referer")).toString();s instanceof Response&&(s.headers.has("X-Revalidate")&&(t=s.headers.get("X-Revalidate").split(",")),s.headers.has("Location")&&(n=new URL(s.headers.get("Location"),new URL(e.request.url).origin+"").toString()));const o=Ke(e);return o.request=new Request(n,{headers:ht(e)}),await z(o,async()=>{await ct(o),x||(x=(await import("./app-DpBaXL-A.js")).default),o.router.dataOnly=t||!0,o.router.previousUrl=e.request.headers.get("referer");try{pe(()=>{X.context.event=o,x()})}catch(c){console.log(c)}const a=o.router.data;if(!a)return s;let i=!1;for(const c in a)a[c]===void 0?delete a[c]:i=!0;return i&&(s instanceof Response?s.customBody&&(a._$value=s.customBody()):(a._$value=s,s=new Response(null,{status:200})),s.customBody=()=>a,s.headers.set("X-Single-Flight","true")),s})}const qt=He(ft);export{kt as F,qt as h};
