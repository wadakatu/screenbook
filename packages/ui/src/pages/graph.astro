---
import Layout from "@/layouts/Layout.astro"
import { loadScreens } from "@/utils/loadScreens"

const screens = loadScreens()

// Generate Mermaid graph
let mermaidGraph = ""
if (screens.length > 0) {
	const lines: string[] = ["flowchart TD"]

	for (const screen of screens) {
		const label = screen.title.replace(/"/g, "'")
		const id = screen.id.replace(/\./g, "_")
		lines.push(`    ${id}["${label}"]`)
	}

	lines.push("")

	for (const screen of screens) {
		if (screen.next) {
			const fromId = screen.id.replace(/\./g, "_")
			for (const nextId of screen.next) {
				const toId = nextId.replace(/\./g, "_")
				lines.push(`    ${fromId} --> ${toId}`)
			}
		}
	}

	mermaidGraph = lines.join("\n")
}
---

<Layout title="Navigation Graph" currentPage="graph">
	<div class="container">
		<div class="page-header">
			<h1 class="page-title">Navigation Graph</h1>
			<p class="page-description">
				Visualize how users navigate between screens in your application.
			</p>
		</div>

		{screens.length === 0 ? (
			<div class="empty-state">
				<svg class="empty-state-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
					<path stroke-linecap="round" stroke-linejoin="round" d="M7.5 21L3 16.5m0 0L7.5 12M3 16.5h13.5m0-13.5L21 7.5m0 0L16.5 12M21 7.5H7.5" />
				</svg>
				<h2 class="empty-state-title">No navigation data</h2>
				<p class="empty-state-description">
					Run the build command to generate screen metadata.
				</p>
				<code class="empty-state-code">
					<span class="prompt">$</span> screenbook build
				</code>
			</div>
		) : (
			<>
				<div class="graph-container">
					<pre class="mermaid">{mermaidGraph}</pre>
				</div>

				<div class="graph-legend">
					<div class="graph-legend-item">
						<div class="legend-node"></div>
						<span>Screen</span>
					</div>
					<div class="graph-legend-item">
						<div class="legend-edge"></div>
						<span>Navigation</span>
					</div>
				</div>
			</>
		)}
	</div>

	<script>
		import mermaid from "mermaid"

		mermaid.initialize({
			startOnLoad: true,
			theme: "dark",
			themeVariables: {
				darkMode: true,
				background: "transparent",
				primaryColor: "#222222",
				primaryBorderColor: "#3a3a3a",
				primaryTextColor: "#eeeeee",
				lineColor: "#5eead4",
				fontFamily: "system-ui, sans-serif",
			},
			flowchart: {
				useMaxWidth: true,
				htmlLabels: true,
				curve: "basis",
				padding: 20,
				nodeSpacing: 50,
				rankSpacing: 60,
			},
		})
	</script>
</Layout>
