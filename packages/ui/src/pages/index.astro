---
import Layout from "@/layouts/Layout.astro"
import { loadScreens } from "@/utils/loadScreens"

const screens = loadScreens()
const allTags = [...new Set(screens.flatMap((s) => s.tags ?? []))]
---

<Layout title="Screens" currentPage="screens">
	<div class="container">
		<div class="page-header">
			<h1 class="page-title">Screens</h1>
			<p class="page-description">
				Browse all screens in your application. Click on a screen to see details and navigation flows.
			</p>
		</div>

		{screens.length === 0 ? (
			<div class="empty-state">
				<svg class="empty-state-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
					<path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m2.25 0H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" />
				</svg>
				<h2 class="empty-state-title">No screens found</h2>
				<p class="empty-state-description">
					Run the build command to generate screen metadata.
				</p>
				<code class="empty-state-code">
					<span class="prompt">$</span> screenbook build
				</code>
			</div>
		) : (
			<>
				<div class="search-wrapper">
					<svg class="search-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
						<path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
					</svg>
					<input
						type="text"
						id="search"
						placeholder="Search screens..."
						class="search-input"
					/>
				</div>

				{allTags.length > 0 && (
					<div class="tags">
						{allTags.map((tag) => (
							<button class="tag" data-tag={tag}>{tag}</button>
						))}
					</div>
				)}

				<div class="screen-grid" id="screen-list">
					{screens.map((screen) => (
						<a
							href={`/screen/${screen.id}`}
							class="card-link"
							data-tags={screen.tags?.join(",") ?? ""}
							data-title={screen.title.toLowerCase()}
							data-id={screen.id.toLowerCase()}
						>
							<div class="card">
								<h3 class="card-title">{screen.title}</h3>
								<div class="card-route">{screen.route}</div>
								<div class="card-meta">
									<span class="card-meta-item">
										<svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
											<path stroke-linecap="round" stroke-linejoin="round" d="M5.25 8.25h15m-16.5 7.5h15m-1.8-13.5l-3.9 19.5m-2.1-19.5l-3.9 19.5" />
										</svg>
										{screen.id}
									</span>
									{screen.owner && screen.owner.length > 0 && (
										<span class="card-meta-item">
											<svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
												<path stroke-linecap="round" stroke-linejoin="round" d="M15 19.128a9.38 9.38 0 002.625.372 9.337 9.337 0 004.121-.952 4.125 4.125 0 00-7.533-2.493M15 19.128v-.003c0-1.113-.285-2.16-.786-3.07M15 19.128v.106A12.318 12.318 0 018.624 21c-2.331 0-4.512-.645-6.374-1.766l-.001-.109a6.375 6.375 0 0111.964-3.07M12 6.375a3.375 3.375 0 11-6.75 0 3.375 3.375 0 016.75 0zm8.25 2.25a2.625 2.625 0 11-5.25 0 2.625 2.625 0 015.25 0z" />
											</svg>
											{screen.owner.join(", ")}
										</span>
									)}
								</div>
								{screen.tags && screen.tags.length > 0 && (
									<div class="card-tags">
										{screen.tags.map((tag) => (
											<span class="card-tag">{tag}</span>
										))}
									</div>
								)}
							</div>
						</a>
					))}
				</div>
			</>
		)}
	</div>

	<script>
		const searchInput = document.getElementById("search") as HTMLInputElement
		const screenList = document.getElementById("screen-list")
		const tagButtons = document.querySelectorAll(".tag")

		let activeTag: string | null = null

		function filterScreens() {
			const query = searchInput?.value.toLowerCase() ?? ""
			const cards = screenList?.querySelectorAll(".card-link") as NodeListOf<HTMLElement>

			cards?.forEach((card) => {
				const title = card.dataset.title ?? ""
				const id = card.dataset.id ?? ""
				const tags = card.dataset.tags ?? ""

				const matchesSearch = title.includes(query) || id.includes(query)
				const matchesTag = !activeTag || tags.includes(activeTag)

				card.style.display = matchesSearch && matchesTag ? "block" : "none"
			})
		}

		searchInput?.addEventListener("input", filterScreens)

		tagButtons.forEach((btn) => {
			btn.addEventListener("click", () => {
				const tag = (btn as HTMLElement).dataset.tag
				if (activeTag === tag) {
					activeTag = null
					tagButtons.forEach((b) => b.classList.remove("active"))
				} else {
					tagButtons.forEach((b) => b.classList.remove("active"))
					activeTag = tag ?? null
					btn.classList.add("active")
				}
				filterScreens()
			})
		})
	</script>
</Layout>
